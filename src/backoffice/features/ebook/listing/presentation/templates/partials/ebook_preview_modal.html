<!-- Modal d'aperçu d'ebook -->
<div class="modal-header">
    <div class="d-flex flex-column w-100">
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <h5 class="modal-title" id="ebookPreviewModalLabel">
                    <i class="fas fa-book me-2"></i>{{ ebook.title }}
                </h5>
                <p class="text-muted mb-0 small">par {{ ebook.author }}</p>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="mt-3 d-flex gap-2 align-items-center flex-wrap">
            <span class="badge {{ ebook.status|ebook_status_class }}">
                {{ ebook.status|ebook_status_label }}
            </span>
            <span class="text-muted small">
                <i class="fas fa-calendar me-1"></i>{{ ebook.created_at|date }}
            </span>
            {% if ebook.theme_id %}
            <span class="badge bg-secondary">
                <i class="fas fa-palette me-1"></i>{{ ebook.theme_id }}
            </span>
            {% endif %}
        </div>
    </div>
</div>

<div class="modal-body">
    <!-- PDF Viewer -->
    <div class="pdf-viewer-container mb-4" style="min-height: 600px; border: 1px solid #dee2e6; border-radius: 0.375rem; background: #f8f9fa;">
        {% if ebook.preview_url %}
            <!-- Google Drive PDF Embed (APPROVED ebooks) -->
            <iframe
                src="https://drive.google.com/file/d/{{ ebook.drive_id }}/preview"
                width="100%"
                height="600"
                frameborder="0"
                allow="autoplay"
                style="border-radius: 0.375rem;"
                data-testid="pdf-viewer">
            </iframe>
        {% elif ebook.status.value == 'DRAFT' %}
            <!-- Local PDF Embed (DRAFT ebooks - before Drive upload) -->
            <iframe
                src="/api/ebooks/{{ ebook.id }}/pdf"
                width="100%"
                height="600"
                frameborder="0"
                style="border-radius: 0.375rem;"
                data-testid="pdf-viewer">
            </iframe>
        {% else %}
            <div class="d-flex flex-column align-items-center justify-content-center h-100 text-muted" style="min-height: 600px;">
                <i class="fas fa-file-pdf fa-4x mb-3"></i>
                <p>Aucun aperçu disponible</p>
                <small>Le PDF est en cours de génération</small>
            </div>
        {% endif %}
    </div>

    <!-- ========== SECTION 1: PRÉVISUALISATION ========== -->
    {% if ebook.status.value in ['DRAFT', 'APPROVED'] %}
    <div class="card mb-3 border-info">
        <div class="card-header bg-info bg-opacity-10 border-info">
            <h6 class="mb-0 text-info">
                <i class="fas fa-eye me-2"></i>Prévisualisation
            </h6>
        </div>
        <div class="card-body">
            <div class="d-flex gap-2 flex-wrap">
                <button class="btn btn-outline-info"
                        onclick="showKDPCoverPreview({{ ebook.id }})"
                        data-testid="preview-kdp-cover-btn">
                    <i class="fas fa-ruler-combined me-2"></i>
                    Aperçu Cover KDP
                </button>
                <button class="btn btn-outline-info"
                        onclick="showKDPInteriorPreview({{ ebook.id }})"
                        data-testid="preview-kdp-interior-btn">
                    <i class="fas fa-book-open me-2"></i>
                    Aperçu Interior KDP
                </button>
            </div>
            <small class="text-muted d-block mt-2">
                <i class="fas fa-info-circle me-1"></i>
                Visualisez les PDF KDP avant téléchargement ou approbation
            </small>
        </div>
    </div>
    {% endif %}

    <!-- ========== SECTION 2: TÉLÉCHARGEMENTS ========== -->
    {% if ebook.status.value in ['DRAFT', 'APPROVED'] %}
    <div class="card mb-3 border-success">
        <div class="card-header bg-success bg-opacity-10 border-success">
            <h6 class="mb-0 text-success">
                <i class="fas fa-download me-2"></i>Téléchargements
            </h6>
        </div>
        <div class="card-body">
            <div class="d-flex gap-2 flex-wrap">
                <a href="/api/ebooks/{{ ebook.id }}/export-kdp?preview=true"
                   class="btn btn-success"
                   download
                   data-testid="download-kdp-cover-btn">
                    <i class="fas fa-file-download me-2"></i>
                    Cover KDP
                </a>
                <a href="/api/ebooks/{{ ebook.id }}/export-kdp/interior?preview=true"
                   class="btn btn-success"
                   download
                   data-testid="download-kdp-interior-btn">
                    <i class="fas fa-file-download me-2"></i>
                    Interior KDP
                </a>
            </div>
            <small class="text-muted d-block mt-2">
                <i class="fas fa-info-circle me-1"></i>
                Fichiers prêts pour publication sur Amazon KDP
            </small>
        </div>
    </div>
    {% endif %}

    <!-- ========== SECTION 3: GOOGLE DRIVE (APPROVED uniquement) ========== -->
    {% if ebook.status.value == 'APPROVED' %}
    <div class="card mb-3 border-primary">
        <div class="card-header bg-primary bg-opacity-10 border-primary">
            <h6 class="mb-0 text-primary">
                <i class="fab fa-google-drive me-2"></i>Google Drive
            </h6>
        </div>
        <div class="card-body">
            <div class="d-flex gap-2 flex-wrap">
                {% if ebook.drive_id_cover %}
                <a href="https://drive.google.com/file/d/{{ ebook.drive_id_cover }}/view"
                   target="_blank"
                   class="btn btn-primary"
                   data-testid="open-drive-cover-btn">
                    <i class="fas fa-external-link-alt me-2"></i>
                    Ouvrir Cover dans Drive
                </a>
                {% endif %}
                {% if ebook.drive_id_interior %}
                <a href="https://drive.google.com/file/d/{{ ebook.drive_id_interior }}/view"
                   target="_blank"
                   class="btn btn-primary"
                   data-testid="open-drive-interior-btn">
                    <i class="fas fa-external-link-alt me-2"></i>
                    Ouvrir Interior dans Drive
                </a>
                {% endif %}
            </div>
            <small class="text-muted d-block mt-2">
                <i class="fas fa-cloud me-1"></i>
                Fichiers stockés dans votre Google Drive
            </small>
        </div>
    </div>
    {% endif %}

    <!-- ========== SECTION 4: RÉGÉNÉRATION (DRAFT uniquement) ========== -->
    {% if ebook.status.value == 'DRAFT' %}
    <div class="card mb-3 border-warning">
        <div class="card-header bg-warning bg-opacity-10 border-warning">
            <h6 class="mb-0 text-warning">
                <i class="fas fa-sync-alt me-2"></i>Régénération
            </h6>
        </div>
        <div class="card-body">
            <div class="d-flex gap-2 flex-wrap">
                <button class="btn btn-outline-warning"
                        hx-post="/api/ebooks/{{ ebook.id }}/pages/regenerate"
                        hx-vals='{"page_type": "cover"}'
                        hx-ext="json-enc"
                        hx-indicator="#regenerateCoverSpinner-{{ ebook.id }}"
                        hx-disabled-elt="this"
                        hx-on::after-request="
                            if(event.detail.successful) {
                                createToast('Couverture régénérée avec succès !', 'success');
                                setTimeout(() => { location.reload(); }, 2000);
                            }
                        "
                        data-testid="regenerate-cover-btn">
                    <span id="regenerateCoverSpinner-{{ ebook.id }}" class="spinner-border spinner-border-sm me-2 htmx-indicator" aria-hidden="true"></span>
                    <i class="fas fa-sync-alt me-2"></i>
                    Couverture
                </button>

                <button class="btn btn-outline-warning"
                        hx-post="/api/ebooks/{{ ebook.id }}/pages/regenerate"
                        hx-vals='{"page_type": "back_cover"}'
                        hx-ext="json-enc"
                        hx-indicator="#regenerateBackCoverSpinner-{{ ebook.id }}"
                        hx-disabled-elt="this"
                        hx-on::after-request="
                            if(event.detail.successful) {
                                createToast('4ème de couverture régénérée avec succès !', 'success');
                                setTimeout(() => { location.reload(); }, 2000);
                            }
                        "
                        data-testid="regenerate-back-cover-btn">
                    <span id="regenerateBackCoverSpinner-{{ ebook.id }}" class="spinner-border spinner-border-sm me-2 htmx-indicator" aria-hidden="true"></span>
                    <i class="fas fa-sync-alt me-2"></i>
                    4ème de couv.
                </button>

                <!-- Button to open multi-page regeneration modal -->
                <button type="button"
                        class="btn btn-outline-warning"
                        data-bs-toggle="modal"
                        data-bs-target="#multiPageRegenerateModal-{{ ebook.id }}">
                    <i class="fas fa-palette me-2"></i>
                    Pages coloriage
                </button>
            </div>
            <small class="text-muted d-block mt-2">
                <i class="fas fa-magic me-1"></i>
                Régénérez les pages qui ne vous conviennent pas
            </small>
        </div>
    </div>
    {% endif %}

    <!-- ========== SECTION 5: ACTIONS (Approve/Reject) ========== -->
    <div class="card border-secondary">
        <div class="card-header bg-secondary bg-opacity-10 border-secondary">
            <h6 class="mb-0">
                <i class="fas fa-tasks me-2"></i>Actions
            </h6>
        </div>
        <div class="card-body">
            <div class="d-flex gap-2 flex-wrap">
                {% if ebook.status.value == 'DRAFT' %}
                <!-- Approve Button (DRAFT → upload to Drive → APPROVED) -->
                <button class="btn btn-success"
                        hx-put="/api/dashboard/ebooks/{{ ebook.id }}/approve"
                        hx-indicator="#approveSpinner-{{ ebook.id }}"
                        hx-disabled-elt="this"
                        hx-on::after-request="
                            if(event.detail.successful) {
                                createToast('Ebook approuvé : 2 fichiers KDP uploadés sur Drive !', 'success');
                                setTimeout(() => { location.reload(); }, 2000);
                            }
                        "
                        data-testid="approve-btn">
                    <span id="approveSpinner-{{ ebook.id }}" class="spinner-border spinner-border-sm me-2 htmx-indicator" aria-hidden="true"></span>
                    <i class="fas fa-check me-2"></i>
                    Approuver
                </button>

                <!-- Reject Button (DRAFT → REJECTED) -->
                <button class="btn btn-danger"
                        hx-put="/api/dashboard/ebooks/{{ ebook.id }}/reject"
                        hx-indicator="#rejectSpinner-{{ ebook.id }}"
                        hx-disabled-elt="this"
                        hx-confirm="Êtes-vous sûr de vouloir rejeter cet ebook ?"
                        hx-on::after-request="
                            if(event.detail.successful) {
                                createToast('Ebook rejeté', 'info');
                                setTimeout(() => { location.reload(); }, 2000);
                            }
                        "
                        data-testid="reject-btn">
                    <span id="rejectSpinner-{{ ebook.id }}" class="spinner-border spinner-border-sm me-2 htmx-indicator" aria-hidden="true"></span>
                    <i class="fas fa-times me-2"></i>
                    Rejeter
                </button>
                {% endif %}

                <!-- APPROVED Status Actions: Reject only (if problem found) -->
                {% if ebook.status.value == 'APPROVED' %}
                <button class="btn btn-outline-danger"
                        hx-put="/api/dashboard/ebooks/{{ ebook.id }}/reject"
                        hx-indicator="#rejectApprovedSpinner-{{ ebook.id }}"
                        hx-disabled-elt="this"
                        hx-confirm="Êtes-vous sûr de vouloir rejeter cet ebook approuvé ?"
                        hx-on::after-request="
                            if(event.detail.successful) {
                                createToast('Ebook rejeté', 'info');
                                setTimeout(() => { location.reload(); }, 2000);
                            }
                        "
                        data-testid="reject-approved-btn">
                    <span id="rejectApprovedSpinner-{{ ebook.id }}" class="spinner-border spinner-border-sm me-2 htmx-indicator" aria-hidden="true"></span>
                    <i class="fas fa-times me-2"></i>
                    Rejeter
                </button>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Info Section -->
    <div class="mt-4">
        <h6 class="fw-bold mb-3">
            <i class="fas fa-info-circle me-2"></i>Informations
        </h6>
        <div class="row">
            <div class="col-md-6">
                <dl class="row small">
                    <dt class="col-sm-4">ID:</dt>
                    <dd class="col-sm-8">{{ ebook.id }}</dd>

                    <dt class="col-sm-4">Statut:</dt>
                    <dd class="col-sm-8">
                        <span class="badge {{ ebook.status|ebook_status_class }}">
                            {{ ebook.status|ebook_status_label }}
                        </span>
                    </dd>

                    {% if ebook.config %}
                    <dt class="col-sm-4">Format:</dt>
                    <dd class="col-sm-8">{{ ebook.config.format|upper }}</dd>
                    {% endif %}
                </dl>
            </div>
            <div class="col-md-6">
                <dl class="row small">
                    {% if ebook.config and ebook.config.number_of_chapters %}
                    <dt class="col-sm-5">Chapitres:</dt>
                    <dd class="col-sm-7">{{ ebook.config.number_of_chapters }}</dd>
                    {% endif %}

                    {% if ebook.config and ebook.config.number_of_pages %}
                    <dt class="col-sm-5">Pages:</dt>
                    <dd class="col-sm-7">{{ ebook.config.number_of_pages }}</dd>
                    {% endif %}

                    {% if ebook.audience %}
                    <dt class="col-sm-5">Public:</dt>
                    <dd class="col-sm-7">{{ ebook.audience }}</dd>
                    {% endif %}
                </dl>
            </div>
        </div>
    </div>
</div>

<div class="modal-footer">
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
        Fermer
    </button>
</div>

<!-- Multi-page regeneration modal -->
<div class="modal fade" id="multiPageRegenerateModal-{{ ebook.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-palette me-2"></i>Régénérer les pages de coloriage
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-3">Sélectionnez les pages à régénérer :</p>
                <div id="pageCheckboxes-{{ ebook.id }}" class="d-flex flex-column gap-2" style="max-height: 300px; overflow-y: auto;">
                    {% if ebook.structure_json and ebook.structure_json.pages_meta %}
                        {% for page in ebook.structure_json.pages_meta %}
                            {% if page.page_number > 0 and page.page_number < (ebook.structure_json.pages_meta|length - 1) %}
                            <div class="form-check">
                                <input class="form-check-input page-checkbox-{{ ebook.id }}"
                                       type="checkbox"
                                       value="{{ page.page_number }}"
                                       id="page-{{ ebook.id }}-{{ page.page_number }}">
                                <label class="form-check-label" for="page-{{ ebook.id }}-{{ page.page_number }}">
                                    Page {{ page.page_number }}
                                </label>
                            </div>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                </div>
                <div class="mt-3">
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="selectAllPages({{ ebook.id }})">
                        <i class="fas fa-check-double me-1"></i>Tout sélectionner
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="deselectAllPages({{ ebook.id }})">
                        <i class="fas fa-times me-1"></i>Tout désélectionner
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button"
                        class="btn btn-warning"
                        onclick="regenerateSelectedPages({{ ebook.id }})"
                        id="regenerateSelectedBtn-{{ ebook.id }}">
                    <span id="regenerateSelectedSpinner-{{ ebook.id }}" class="spinner-border spinner-border-sm me-2 d-none" aria-hidden="true"></span>
                    <i class="fas fa-sync-alt me-2"></i>
                    Régénérer
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function showKDPCoverPreview(ebookId) {
    // Replace current PDF viewer with KDP cover preview (image with overlay)
    const pdfContainer = document.querySelector('.pdf-viewer-container');
    if (!pdfContainer) return;

    // Show loading state
    pdfContainer.innerHTML = `
        <div class="d-flex flex-column align-items-center justify-content-center h-100" style="min-height: 600px;">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Génération de l'aperçu cover KDP...</span>
            </div>
            <p class="text-muted">Génération de l'aperçu cover KDP en cours...</p>
            <small class="text-muted">Assemblage: back + spine + front avec overlay KDP...</small>
        </div>
    `;

    // Load KDP cover preview image
    setTimeout(() => {
        pdfContainer.innerHTML = `
            <div class="text-center" style="background: #f8f9fa; padding: 20px; border-radius: 0.375rem; overflow: auto;">
                <img
                    src="/api/ebooks/${ebookId}/kdp-cover-preview"
                    alt="KDP Cover Preview"
                    style="max-width: 100%; height: auto; border: 1px solid #dee2e6; border-radius: 0.375rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"
                    data-testid="kdp-cover-preview-img">
                <p class="text-muted mt-3 small">
                    <i class="fas fa-info-circle me-1"></i>
                    Vérifiez que le contenu important est bien dans les zones de sécurité (évitez les zones rouges du template)
                </p>
            </div>
        `;
    }, 100);
}

function showKDPPreview(ebookId) {
    // Replace current PDF viewer with KDP PDF preview
    const pdfContainer = document.querySelector('.pdf-viewer-container');
    if (!pdfContainer) return;

    // Show loading state
    pdfContainer.innerHTML = `
        <div class="d-flex flex-column align-items-center justify-content-center h-100" style="min-height: 600px;">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Génération de l'aperçu PDF KDP...</span>
            </div>
            <p class="text-muted">Génération de l'aperçu PDF KDP en cours...</p>
            <small class="text-muted">Cela peut prendre quelques secondes</small>
        </div>
    `;

    // Load KDP PDF preview
    setTimeout(() => {
        pdfContainer.innerHTML = `
            <iframe
                src="/api/ebooks/${ebookId}/export-kdp?preview=true"
                width="100%"
                height="600"
                frameborder="0"
                style="border-radius: 0.375rem;"
                data-testid="kdp-preview">
            </iframe>
        `;
    }, 100);
}

function showKDPInteriorPreview(ebookId) {
    // Replace current PDF viewer with KDP Interior PDF preview
    const pdfContainer = document.querySelector('.pdf-viewer-container');
    if (!pdfContainer) return;

    // Show loading state
    pdfContainer.innerHTML = `
        <div class="d-flex flex-column align-items-center justify-content-center h-100" style="min-height: 600px;">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Génération de l'aperçu Interior KDP...</span>
            </div>
            <p class="text-muted">Génération de l'aperçu Interior KDP en cours...</p>
            <small class="text-muted">Pages intérieures uniquement (sans cover ni back cover)</small>
        </div>
    `;

    // Load KDP Interior PDF preview
    setTimeout(() => {
        pdfContainer.innerHTML = `
            <iframe
                src="/api/ebooks/${ebookId}/export-kdp/interior?preview=true"
                width="100%"
                height="600"
                frameborder="0"
                style="border-radius: 0.375rem;"
                data-testid="kdp-interior-preview">
            </iframe>
        `;
    }, 100);
}

function selectAllPages(ebookId) {
    document.querySelectorAll(`.page-checkbox-${ebookId}`).forEach(checkbox => {
        checkbox.checked = true;
    });
}

function deselectAllPages(ebookId) {
    document.querySelectorAll(`.page-checkbox-${ebookId}`).forEach(checkbox => {
        checkbox.checked = false;
    });
}

async function regenerateSelectedPages(ebookId) {
    // Get all checked pages
    const selectedPages = Array.from(document.querySelectorAll(`.page-checkbox-${ebookId}:checked`))
        .map(checkbox => parseInt(checkbox.value));

    if (selectedPages.length === 0) {
        createToast('Veuillez sélectionner au moins une page', 'warning');
        return;
    }

    // Show loading state
    const spinner = document.getElementById(`regenerateSelectedSpinner-${ebookId}`);
    const btn = document.getElementById(`regenerateSelectedBtn-${ebookId}`);
    spinner.classList.remove('d-none');
    btn.disabled = true;

    try {
        const response = await fetch(`/api/ebooks/${ebookId}/pages/regenerate`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                page_type: 'content_page',
                page_indices: selectedPages
            })
        });

        const result = await response.json();

        if (response.ok && result.success) {
            createToast(result.message || `${selectedPages.length} page(s) régénérée(s) avec succès !`, 'success');

            // Close the multi-page modal
            const modal = bootstrap.Modal.getInstance(document.getElementById(`multiPageRegenerateModal-${ebookId}`));
            if (modal) modal.hide();

            // Reload after 2 seconds to show updated PDF
            setTimeout(() => { location.reload(); }, 2000);
        } else {
            createToast(result.detail || 'Erreur lors de la régénération', 'error');
        }
    } catch (error) {
        console.error('Error regenerating pages:', error);
        createToast('Erreur lors de la régénération des pages', 'error');
    } finally {
        spinner.classList.add('d-none');
        btn.disabled = false;
    }
}
</script>
