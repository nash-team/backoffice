<!-- Modal d'aperçu d'ebook -->
<div class="modal-header">
    <div class="d-flex flex-column w-100">
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <h5 class="modal-title" id="ebookPreviewModalLabel">
                    <i class="fas fa-book me-2"></i>{{ ebook.title }}
                </h5>
                <p class="text-muted mb-0 small">par {{ ebook.author }}</p>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="mt-3 d-flex gap-2 align-items-center flex-wrap">
            <span class="badge {{ ebook.status|ebook_status_class }}">
                {{ ebook.status|ebook_status_label }}
            </span>
            <span class="text-muted small">
                <i class="fas fa-calendar me-1"></i>{{ ebook.created_at|date }}
            </span>
            {% if ebook.theme_id %}
            <span class="badge bg-secondary">
                <i class="fas fa-palette me-1"></i>{{ ebook.theme_id }}
            </span>
            {% endif %}
        </div>
    </div>
</div>

<div class="modal-body">
    <!-- PDF Viewer -->
    <div class="pdf-viewer-container mb-4" style="min-height: 600px; border: 1px solid #dee2e6; border-radius: 0.375rem; background: #f8f9fa;">
        {% if ebook.preview_url %}
            <!-- Google Drive PDF Embed (APPROVED ebooks) -->
            <iframe
                src="https://drive.google.com/file/d/{{ ebook.drive_id }}/preview"
                width="100%"
                height="600"
                frameborder="0"
                allow="autoplay"
                style="border-radius: 0.375rem;"
                data-testid="pdf-viewer">
            </iframe>
        {% elif ebook.status.value == 'DRAFT' %}
            <!-- Local PDF Embed (DRAFT ebooks - before Drive upload) -->
            <iframe
                src="/api/dashboard/ebooks/{{ ebook.id }}/pdf"
                width="100%"
                height="600"
                frameborder="0"
                style="border-radius: 0.375rem;"
                data-testid="pdf-viewer">
            </iframe>
        {% else %}
            <div class="d-flex flex-column align-items-center justify-content-center h-100 text-muted" style="min-height: 600px;">
                <i class="fas fa-file-pdf fa-4x mb-3"></i>
                <p>Aucun aperçu disponible</p>
                <small>Le PDF est en cours de génération</small>
            </div>
        {% endif %}
    </div>

    <!-- Action Buttons -->
    <div class="d-flex gap-2 flex-wrap">
        <!-- Open in Google Drive -->
        {% if ebook.preview_url %}
        <a href="https://drive.google.com/file/d/{{ ebook.drive_id }}/view"
           target="_blank"
           class="btn btn-outline-primary"
           data-testid="open-drive-btn">
            <i class="fas fa-external-link-alt me-2"></i>
            Ouvrir dans Drive
        </a>
        {% endif %}

        <!-- KDP Preview (for DRAFT and APPROVED ebooks) -->
        {% if ebook.status.value in ['DRAFT', 'APPROVED'] %}
        <button class="btn btn-outline-info"
                onclick="showKDPPreview({{ ebook.id }})"
                data-testid="preview-kdp-btn">
            <i class="fas fa-eye me-2"></i>
            Aperçu KDP
        </button>
        {% endif %}

        <!-- KDP Download (only for APPROVED ebooks) -->
        {% if ebook.status.value == 'APPROVED' %}
        <a href="/api/dashboard/ebooks/{{ ebook.id }}/export-kdp"
           class="btn btn-outline-success"
           download
           data-testid="export-kdp-btn">
            <i class="fas fa-file-download me-2"></i>
            Télécharger KDP
        </a>
        {% endif %}

        <!-- DRAFT Status Actions: Regenerate + Approve/Reject -->
        {% if ebook.status.value == 'DRAFT' %}
        <button class="btn btn-outline-warning"
                hx-post="/api/ebooks/{{ ebook.id }}/pages/regenerate"
                hx-vals='{"page_type": "cover", "page_index": 0}'
                hx-ext="json-enc"
                hx-indicator="#regenerateCoverSpinner-{{ ebook.id }}"
                hx-disabled-elt="this"
                hx-on::after-request="
                    if(event.detail.successful) {
                        createToast('Couverture régénérée avec succès !', 'success');
                        setTimeout(() => { location.reload(); }, 2000);
                    }
                "
                data-testid="regenerate-cover-btn">
            <span id="regenerateCoverSpinner-{{ ebook.id }}" class="spinner-border spinner-border-sm me-2 htmx-indicator" aria-hidden="true"></span>
            <i class="fas fa-sync-alt me-2"></i>
            Régénérer la couverture
        </button>

        <button class="btn btn-outline-warning"
                hx-post="/api/ebooks/{{ ebook.id }}/pages/regenerate"
                hx-vals='{"page_type": "back_cover"}'
                hx-ext="json-enc"
                hx-indicator="#regenerateBackCoverSpinner-{{ ebook.id }}"
                hx-disabled-elt="this"
                hx-on::after-request="
                    if(event.detail.successful) {
                        createToast('4ème de couverture régénérée avec succès !', 'success');
                        setTimeout(() => { location.reload(); }, 2000);
                    }
                "
                data-testid="regenerate-back-cover-btn">
            <span id="regenerateBackCoverSpinner-{{ ebook.id }}" class="spinner-border spinner-border-sm me-2 htmx-indicator" aria-hidden="true"></span>
            <i class="fas fa-sync-alt me-2"></i>
            Régénérer la 4ème de couv.
        </button>

        <!-- Dropdown for regenerating coloring pages -->
        <div class="btn-group">
            <button type="button" class="btn btn-outline-info dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-palette me-2"></i>
                Régénérer page coloriage
            </button>
            <ul class="dropdown-menu">
                {% if ebook.structure_json and ebook.structure_json.pages_meta %}
                    {% for page in ebook.structure_json.pages_meta %}
                        {% if page.page_number > 0 and page.page_number < (ebook.structure_json.pages_meta|length - 1) %}
                        <li>
                            <a class="dropdown-item" href="#"
                               hx-post="/api/ebooks/{{ ebook.id }}/pages/regenerate"
                               hx-vals='{"page_type": "content_page", "page_index": {{ page.page_number }}}'
                               hx-ext="json-enc"
                               hx-indicator="#regeneratePageSpinner-{{ ebook.id }}-{{ page.page_number }}"
                               hx-disabled-elt="this"
                               hx-on::after-request="
                                   if(event.detail.successful) {
                                       createToast('Page {{ page.page_number }} régénérée !', 'success');
                                       setTimeout(() => { location.reload(); }, 2000);
                                   }
                               ">
                                <span id="regeneratePageSpinner-{{ ebook.id }}-{{ page.page_number }}" class="spinner-border spinner-border-sm me-2 htmx-indicator" aria-hidden="true"></span>
                                Page {{ page.page_number }}
                            </a>
                        </li>
                        {% endif %}
                    {% endfor %}
                {% endif %}
            </ul>
        </div>

        <!-- Approve Button (DRAFT → upload to Drive → APPROVED) -->
        <button class="btn btn-success"
                hx-post="/api/ebooks/{{ ebook.id }}/approve"
                hx-indicator="#approveSpinner-{{ ebook.id }}"
                hx-disabled-elt="this"
                hx-on::after-request="
                    if(event.detail.successful) {
                        createToast('Ebook approuvé et uploadé sur Drive !', 'success');
                        setTimeout(() => { location.reload(); }, 2000);
                    }
                "
                data-testid="approve-btn">
            <span id="approveSpinner-{{ ebook.id }}" class="spinner-border spinner-border-sm me-2 htmx-indicator" aria-hidden="true"></span>
            <i class="fas fa-check me-2"></i>
            Approuver
        </button>

        <!-- Reject Button (DRAFT → REJECTED) -->
        <button class="btn btn-danger"
                hx-post="/api/ebooks/{{ ebook.id }}/reject"
                hx-indicator="#rejectSpinner-{{ ebook.id }}"
                hx-disabled-elt="this"
                hx-confirm="Êtes-vous sûr de vouloir rejeter cet ebook ?"
                hx-on::after-request="
                    if(event.detail.successful) {
                        createToast('Ebook rejeté', 'info');
                        setTimeout(() => { location.reload(); }, 2000);
                    }
                "
                data-testid="reject-btn">
            <span id="rejectSpinner-{{ ebook.id }}" class="spinner-border spinner-border-sm me-2 htmx-indicator" aria-hidden="true"></span>
            <i class="fas fa-times me-2"></i>
            Rejeter
        </button>
        {% endif %}

        <!-- APPROVED Status Actions: Reject only (if problem found) -->
        {% if ebook.status.value == 'APPROVED' %}
        <button class="btn btn-outline-danger"
                hx-post="/api/ebooks/{{ ebook.id }}/reject"
                hx-indicator="#rejectApprovedSpinner-{{ ebook.id }}"
                hx-disabled-elt="this"
                hx-confirm="Êtes-vous sûr de vouloir rejeter cet ebook approuvé ?"
                hx-on::after-request="
                    if(event.detail.successful) {
                        createToast('Ebook rejeté', 'info');
                        setTimeout(() => { location.reload(); }, 2000);
                    }
                "
                data-testid="reject-approved-btn">
            <span id="rejectApprovedSpinner-{{ ebook.id }}" class="spinner-border spinner-border-sm me-2 htmx-indicator" aria-hidden="true"></span>
            <i class="fas fa-times me-2"></i>
            Rejeter
        </button>
        {% endif %}
    </div>

    <!-- Info Section -->
    <div class="mt-4">
        <h6 class="fw-bold mb-3">
            <i class="fas fa-info-circle me-2"></i>Informations
        </h6>
        <div class="row">
            <div class="col-md-6">
                <dl class="row small">
                    <dt class="col-sm-4">ID:</dt>
                    <dd class="col-sm-8">{{ ebook.id }}</dd>

                    <dt class="col-sm-4">Statut:</dt>
                    <dd class="col-sm-8">
                        <span class="badge {{ ebook.status|ebook_status_class }}">
                            {{ ebook.status|ebook_status_label }}
                        </span>
                    </dd>

                    {% if ebook.config %}
                    <dt class="col-sm-4">Format:</dt>
                    <dd class="col-sm-8">{{ ebook.config.format|upper }}</dd>
                    {% endif %}
                </dl>
            </div>
            <div class="col-md-6">
                <dl class="row small">
                    {% if ebook.config and ebook.config.number_of_chapters %}
                    <dt class="col-sm-5">Chapitres:</dt>
                    <dd class="col-sm-7">{{ ebook.config.number_of_chapters }}</dd>
                    {% endif %}

                    {% if ebook.config and ebook.config.number_of_pages %}
                    <dt class="col-sm-5">Pages:</dt>
                    <dd class="col-sm-7">{{ ebook.config.number_of_pages }}</dd>
                    {% endif %}

                    {% if ebook.audience %}
                    <dt class="col-sm-5">Public:</dt>
                    <dd class="col-sm-7">{{ ebook.audience }}</dd>
                    {% endif %}
                </dl>
            </div>
        </div>
    </div>
</div>

<div class="modal-footer">
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
        Fermer
    </button>
</div>

<script>
function showKDPPreview(ebookId) {
    // Replace current PDF viewer with KDP preview
    const pdfContainer = document.querySelector('.pdf-viewer-container');
    if (!pdfContainer) return;

    // Show loading state
    pdfContainer.innerHTML = `
        <div class="d-flex flex-column align-items-center justify-content-center h-100" style="min-height: 600px;">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Génération de l'aperçu KDP...</span>
            </div>
            <p class="text-muted">Génération de l'aperçu KDP en cours...</p>
            <small class="text-muted">Cela peut prendre quelques secondes</small>
        </div>
    `;

    // Load KDP preview after a small delay to show loading state
    setTimeout(() => {
        pdfContainer.innerHTML = `
            <iframe
                src="/api/dashboard/ebooks/${ebookId}/export-kdp?preview=true"
                width="100%"
                height="600"
                frameborder="0"
                style="border-radius: 0.375rem;"
                data-testid="kdp-preview">
            </iframe>
        `;
    }, 100);
}
</script>