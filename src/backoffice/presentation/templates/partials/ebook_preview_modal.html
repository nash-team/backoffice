<!-- Modal d'aperçu d'ebook -->
<div class="modal-header">
    <div class="d-flex flex-column w-100">
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <h5 class="modal-title" id="ebookPreviewModalLabel">
                    <i class="fas fa-book me-2"></i>{{ ebook.title }}
                </h5>
                <p class="text-muted mb-0 small">par {{ ebook.author }}</p>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="mt-3 d-flex gap-2 align-items-center flex-wrap">
            <span class="badge {{ ebook.status|ebook_status_class }}">
                {{ ebook.status|ebook_status_label }}
            </span>
            <span class="text-muted small">
                <i class="fas fa-calendar me-1"></i>{{ ebook.created_at|date }}
            </span>
            {% if ebook.theme_id %}
            <span class="badge bg-secondary">
                <i class="fas fa-palette me-1"></i>{{ ebook.theme_id }}
            </span>
            {% endif %}
        </div>
    </div>
</div>

<div class="modal-body">
    <!-- PDF Viewer -->
    <div class="pdf-viewer-container mb-4" style="min-height: 600px; border: 1px solid #dee2e6; border-radius: 0.375rem; background: #f8f9fa;">
        {% if ebook.preview_url %}
            <!-- Google Drive PDF Embed -->
            <iframe
                src="https://drive.google.com/file/d/{{ ebook.drive_id }}/preview"
                width="100%"
                height="600"
                frameborder="0"
                allow="autoplay"
                style="border-radius: 0.375rem;"
                data-testid="pdf-viewer">
            </iframe>
        {% else %}
            <div class="d-flex flex-column align-items-center justify-content-center h-100 text-muted" style="min-height: 600px;">
                <i class="fas fa-file-pdf fa-4x mb-3"></i>
                <p>Aucun aperçu disponible</p>
                <small>Le PDF est en cours de génération</small>
            </div>
        {% endif %}
    </div>

    <!-- Action Buttons -->
    <div class="d-flex gap-2 flex-wrap">
        <!-- Open in Google Drive -->
        {% if ebook.preview_url %}
        <a href="https://drive.google.com/file/d/{{ ebook.drive_id }}/view"
           target="_blank"
           class="btn btn-outline-primary"
           data-testid="open-drive-btn">
            <i class="fas fa-external-link-alt me-2"></i>
            Ouvrir dans Drive
        </a>
        {% endif %}

        <!-- Regenerate Cover (available for PENDING ebooks) -->
        {% if ebook.status.value == 'PENDING' or ebook.status.value == 'DRAFT' %}
        <button class="btn btn-outline-warning"
                hx-post="/api/ebooks/{{ ebook.id }}/pages/regenerate"
                hx-vals='{"page_type": "cover", "page_index": 0}'
                hx-ext="json-enc"
                hx-indicator="#regenerateCoverSpinner-{{ ebook.id }}"
                hx-disabled-elt="this"
                hx-on::after-request="
                    if(event.detail.successful) {
                        createToast('Couverture régénérée avec succès !', 'success');
                        // Reload preview after 2s
                        setTimeout(() => {
                            location.reload();
                        }, 2000);
                    }
                "
                data-testid="regenerate-cover-btn">
            <span id="regenerateCoverSpinner-{{ ebook.id }}" class="spinner-border spinner-border-sm me-2 htmx-indicator" aria-hidden="true"></span>
            <i class="fas fa-sync-alt me-2"></i>
            Régénérer la couverture
        </button>
        {% endif %}
    </div>

    <!-- Info Section -->
    <div class="mt-4">
        <h6 class="fw-bold mb-3">
            <i class="fas fa-info-circle me-2"></i>Informations
        </h6>
        <div class="row">
            <div class="col-md-6">
                <dl class="row small">
                    <dt class="col-sm-4">ID:</dt>
                    <dd class="col-sm-8">{{ ebook.id }}</dd>

                    <dt class="col-sm-4">Statut:</dt>
                    <dd class="col-sm-8">
                        <span class="badge {{ ebook.status|ebook_status_class }}">
                            {{ ebook.status|ebook_status_label }}
                        </span>
                    </dd>

                    {% if ebook.config %}
                    <dt class="col-sm-4">Format:</dt>
                    <dd class="col-sm-8">{{ ebook.config.format|upper }}</dd>
                    {% endif %}
                </dl>
            </div>
            <div class="col-md-6">
                <dl class="row small">
                    {% if ebook.config and ebook.config.number_of_chapters %}
                    <dt class="col-sm-5">Chapitres:</dt>
                    <dd class="col-sm-7">{{ ebook.config.number_of_chapters }}</dd>
                    {% endif %}

                    {% if ebook.config and ebook.config.number_of_pages %}
                    <dt class="col-sm-5">Pages:</dt>
                    <dd class="col-sm-7">{{ ebook.config.number_of_pages }}</dd>
                    {% endif %}

                    {% if ebook.audience %}
                    <dt class="col-sm-5">Public:</dt>
                    <dd class="col-sm-7">{{ ebook.audience }}</dd>
                    {% endif %}
                </dl>
            </div>
        </div>
    </div>
</div>

<div class="modal-footer">
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
        Fermer
    </button>
</div>