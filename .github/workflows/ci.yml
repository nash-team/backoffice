name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    # Skip CI for ebook generation PRs
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'pull_request' && !startsWith(github.event.pull_request.head.ref, 'ebook-generation-'))
    runs-on: ubuntu-latest
    env:
      SECRET_KEY: test-key-for-ci
      GOOGLE_DRIVE_CREDENTIALS_FILE: ${{ secrets.GOOGLE_DRIVE_CREDENTIALS_FILE }}
      ALGORITHM: HS256
      ACCESS_TOKEN_EXPIRE_MINUTES: 30
      DATABASE_URL: postgresql://test:test@localhost:5432/test

    steps:
      - name: â¬‡ï¸ Checkout
        uses: actions/checkout@v4

      - name: ğŸ§¹ Free up disk space
        run: |
          echo "Disk space before cleanup:"
          df -h

          # Remove unnecessary tools and libraries
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL

          # Remove large packages
          sudo apt-get remove -y '^aspnetcore-.*' '^dotnet-.*' '^llvm-.*' 'php.*' '^mongodb-.*' '^mysql-.*' azure-cli google-chrome-stable firefox powershell mono-devel libgl1-mesa-dri
          sudo apt-get autoremove -y
          sudo apt-get clean

          # Clean docker images
          docker rmi $(docker image ls -aq) || true

          echo "Disk space after cleanup:"
          df -h

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install --no-cache-dir -e .[dev]
          python -m playwright install --with-deps chromium

      # Installe les navigateurs + deps systÃ¨me pour Playwright
      - name: ğŸ­ Install Playwright browsers
        run: |
          python -m playwright install --with-deps chromium

      # Lint (corrige rien en CI) + format (check)
      - name: ğŸ§¼ Ruff lint
        run: ruff check .
      - name: ğŸ¨ Ruff format check
        run: ruff format --check .

      # Typage
      - name: ğŸ” Mypy
        run: mypy src/

      # DÃ©pendances (Knip-like)
      - name: ğŸ“š Deptry
        run: deptry src/

      # Code mort (optionnel mais utile)
      - name: ğŸª¦ Vulture
        run: vulture src/ .vulture_whitelist.py --min-confidence=80 --exclude='**/__init__.py'

      # Tests (unit only - integration tests require DB setup)
      - name: ğŸ§ª Pytest (unit)
        run: pytest -m "not integration and not e2e and not scenarios" -v

      - name: ğŸ§ª Pytest (e2e chromium)
        run: make test-e2e
