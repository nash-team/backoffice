name: Ebook Generation Pipeline

on:
  # D√©clench√© quand une issue est cr√©√©e ou rouverte
  issues:
    types: [opened, reopened]

  # Permet le d√©clenchement manuel pour tests
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to process'
        required: false
        type: string

env:
  PYTHON_VERSION: '3.11'

jobs:
  # Job 1: TEST - Juste v√©rifier que le workflow se d√©clenche
  test-trigger:
    name: Test Workflow Trigger
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'ebook-generation')) ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.issue_number != '')

    steps:
      - name: Check trigger
        run: |
          echo "‚úÖ Workflow triggered successfully!"
          echo "Event: ${{ github.event_name }}"
          echo "Issue Number: ${{ github.event.issue.number || github.event.inputs.issue_number }}"

      - name: Check issue details
        if: github.event_name == 'issues'
        run: |
          echo "Issue Title: ${{ github.event.issue.title }}"
          echo "Issue Body Length: ${#ISSUE_BODY}"
          echo "Labels: ${{ join(github.event.issue.labels.*.name, ', ') }}"
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}

  # PHASE 2 - √Ä D√âCOMMENTER APR√àS TEST
  # initialize-from-issue:
  #   name: Initialize from Issue
  #   runs-on: ubuntu-latest
  #   if: |
  #     (github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'ebook-generation')) ||
  #     (github.event_name == 'workflow_dispatch' && github.event.inputs.issue_number != '')
  #
  #   outputs:
  #     pr_number: ${{ steps.create-pr.outputs.pr_number }}
  #     spec_file: ${{ steps.parse.outputs.spec_file }}
  #
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Setup Python
  #       uses: actions/setup-python@v4
  #       with:
  #         python-version: ${{ env.PYTHON_VERSION }}
  #
  #     - name: Install dependencies
  #       run: |
  #         pip install PyYAML requests python-dotenv
  #
  #     - name: Parse issue and create spec
  #       id: parse
  #       env:
  #         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  #         ISSUE_NUMBER: ${{ github.event.issue.number || github.event.inputs.issue_number }}
  #       run: |
  #         python scripts/ci/parse_issue.py \
  #           --issue-number $ISSUE_NUMBER \
  #           --output specs/ebook-$ISSUE_NUMBER.yaml
  #         echo "spec_file=specs/ebook-$ISSUE_NUMBER.yaml" >> $GITHUB_OUTPUT
  #
  #     - name: Create draft PR
  #       id: create-pr
  #       env:
  #         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  #         ISSUE_NUMBER: ${{ github.event.issue.number || github.event.inputs.issue_number }}
  #       run: |
  #         # Create a new branch
  #         BRANCH_NAME="ebook-generation-$ISSUE_NUMBER"
  #         git config user.name "GitHub Actions"
  #         git config user.email "actions@github.com"
  #         git checkout -b $BRANCH_NAME
  #
  #         # Commit the spec file
  #         git add specs/
  #         git commit -m "feat: Add ebook generation spec for issue #$ISSUE_NUMBER"
  #         git push origin $BRANCH_NAME
  #
  #         # Create PR using GitHub API
  #         PR_RESPONSE=$(curl -X POST \
  #           -H "Authorization: token $GITHUB_TOKEN" \
  #           -H "Accept: application/vnd.github.v3+json" \
  #           https://api.github.com/repos/${{ github.repository }}/pulls \
  #           -d '{
  #             "title": "Ebook #'$ISSUE_NUMBER': Generation automatique",
  #             "body": "## üìö G√©n√©ration automatique depuis issue #'$ISSUE_NUMBER'\n\nCette PR contient la g√©n√©ration automatique de l'\''ebook.\n\n### Status\n- [ ] Th√®me valid√©\n- [ ] G√©n√©ration lanc√©e\n- [ ] Review effectu√©e\n- [ ] Upload Drive\n\n---\nIssue: #'$ISSUE_NUMBER'",
  #             "head": "'$BRANCH_NAME'",
  #             "base": "main",
  #             "draft": true
  #           }')
  #
  #         PR_NUMBER=$(echo $PR_RESPONSE | jq -r '.number')
  #         echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
  #
  #         # Link PR to issue
  #         curl -X POST \
  #           -H "Authorization: token $GITHUB_TOKEN" \
  #           -H "Accept: application/vnd.github.v3+json" \
  #           https://api.github.com/repos/${{ github.repository }}/issues/$ISSUE_NUMBER/comments \
  #           -d '{
  #             "body": "üöÄ PR cr√©√©e: #'$PR_NUMBER'\n\nLa g√©n√©ration va d√©marrer une fois la PR pass√©e en Ready for Review."
  #           }'