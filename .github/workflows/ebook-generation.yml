name: Ebook Generation Pipeline

on:
  # DÃ©clenchÃ© quand une issue est crÃ©Ã©e ou rouverte
  issues:
    types: [opened, reopened]

  # Permet le dÃ©clenchement manuel pour tests
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to process'
        required: true
        type: string

env:
  PYTHON_VERSION: '3.11'

# Permissions explicites pour le GITHUB_TOKEN
permissions:
  contents: write      # Pour crÃ©er des branches et commits
  issues: write        # Pour commenter sur les issues
  pull-requests: write # Pour crÃ©er des PRs

jobs:
  # Job 1: Initialisation depuis une issue
  initialize-from-issue:
    name: Initialize from Issue
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'ebook-generation')) ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.issue_number != '')

    outputs:
      pr_number: ${{ steps.create-pr.outputs.pr_number }}
      spec_file: ${{ steps.parse.outputs.spec_file }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install PyYAML requests python-dotenv

      - name: Debug - Check token and API access
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number || github.event.inputs.issue_number }}
        run: |
          echo "Issue number: $ISSUE_NUMBER"
          echo "Repository: ${{ github.repository }}"
          echo "Testing API access with curl..."
          curl -s -H "Authorization: token $GITHUB_TOKEN" \
               -H "Accept: application/vnd.github.v3+json" \
               https://api.github.com/repos/${{ github.repository }}/issues/$ISSUE_NUMBER \
               | jq '.title, .state, .labels[].name' || echo "API call failed"

      - name: Parse issue and create spec
        id: parse
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number || github.event.inputs.issue_number }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          echo "Parsing issue #$ISSUE_NUMBER..."
          python .github/scripts/parse_issue.py \
            --issue-number $ISSUE_NUMBER \
            --repo $GITHUB_REPOSITORY \
            --output specs/ebook-$ISSUE_NUMBER.yaml
          echo "spec_file=specs/ebook-$ISSUE_NUMBER.yaml" >> $GITHUB_OUTPUT

      - name: Display spec
        run: |
          echo "ðŸ“‹ Spec file created:"
          cat specs/ebook-${{ github.event.issue.number || github.event.inputs.issue_number }}.yaml

      - name: Create draft PR
        id: create-pr
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number || github.event.inputs.issue_number }}
        run: |
          echo "ðŸ“ Creating draft PR for issue #$ISSUE_NUMBER..."

          # Create a new branch
          BRANCH_NAME="ebook-generation-$ISSUE_NUMBER"
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          # Check if branch already exists
          if git ls-remote --heads origin $BRANCH_NAME | grep -q $BRANCH_NAME; then
            echo "Branch $BRANCH_NAME already exists, handling existing branch..."

            # Stash any local changes including untracked files
            git add -A
            git stash --include-untracked

            # Fetch and checkout the existing branch
            git fetch origin $BRANCH_NAME
            git checkout $BRANCH_NAME

            # Pull latest changes
            git pull origin $BRANCH_NAME

            # Apply stashed changes
            git stash pop || true
          else
            echo "Creating new branch $BRANCH_NAME..."
            git checkout -b $BRANCH_NAME
          fi

          # Create specs directory if it doesn't exist
          mkdir -p specs

          # Commit the spec file (if there are changes)
          git add specs/
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "feat: Add ebook generation spec for issue #$ISSUE_NUMBER"
          fi

          # Push the branch
          git push origin $BRANCH_NAME

          # Check if PR already exists using gh CLI
          EXISTING_PR=$(gh pr list --repo ${{ github.repository }} --head $BRANCH_NAME --state open --json number --jq '.[0].number' || echo "")

          if [ -n "$EXISTING_PR" ]; then
            echo "PR #$EXISTING_PR already exists for this branch"
            echo "pr_number=$EXISTING_PR" >> $GITHUB_OUTPUT
          else
            # Create PR using gh CLI (this should work even when API is restricted)
            echo "Creating PR using gh CLI..."

            # Ensure we're authenticated properly
            gh auth status

            # Create the PR using gh CLI with inline body (add timeout and debug)
            echo "Running: gh pr create --repo ${{ github.repository }} --base main --head $BRANCH_NAME --draft"

            PR_OUTPUT=$(timeout 30 gh pr create \
              --repo "${{ github.repository }}" \
              --title "ðŸŽ¨ Ebook #$ISSUE_NUMBER: GÃ©nÃ©ration automatique" \
              --body "$(printf '## ðŸ“š GÃ©nÃ©ration automatique depuis issue #%s\n\nCette PR contient la gÃ©nÃ©ration automatique de l'"'"'ebook demandÃ©.\n\n### âœ… Checklist\n- [ ] ThÃ¨me validÃ©\n- [ ] GÃ©nÃ©ration lancÃ©e\n- [ ] Review effectuÃ©e\n- [ ] Upload Drive\n\n### ðŸ“Š Status\n- **Issue source**: #%s\n- **Branch**: `%s`\n- **Ã‰tat**: Draft (en attente de gÃ©nÃ©ration)\n\n---\n*Cette PR a Ã©tÃ© crÃ©Ã©e automatiquement par GitHub Actions*' "$ISSUE_NUMBER" "$ISSUE_NUMBER" "$BRANCH_NAME")" \
              --base main \
              --head "$BRANCH_NAME" \
              --draft \
              2>&1 || true)

            echo "PR creation output: $PR_OUTPUT"

            # Check if PR was created successfully (gh returns the PR URL on success)
            if echo "$PR_OUTPUT" | grep -q "github.com.*pull"; then
              # Extract PR number from URL (format: https://github.com/owner/repo/pull/123)
              PR_NUMBER=$(echo "$PR_OUTPUT" | grep -oE 'pull/[0-9]+' | grep -oE '[0-9]+')

              if [ -n "$PR_NUMBER" ]; then
                echo "âœ… PR #$PR_NUMBER created successfully"
                echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT

                # Comment on the issue using gh CLI
                gh issue comment "$ISSUE_NUMBER" \
                  --repo "${{ github.repository }}" \
                  --body "$(printf '## ðŸš€ GÃ©nÃ©ration lancÃ©e!\n\nâœ… PR crÃ©Ã©e: #%s\n\nLa gÃ©nÃ©ration de l'"'"'ebook va maintenant commencer. Vous pouvez suivre le progrÃ¨s dans la PR.\n\n**Prochaines Ã©tapes**:\n1. Validation du thÃ¨me\n2. GÃ©nÃ©ration des pages\n3. Assemblage PDF\n4. Review manuelle\n5. Upload vers Google Drive' "$PR_NUMBER")"
              else
                echo "âš ï¸ PR might have been created but couldn't extract PR number"
                echo "Output was: $PR_OUTPUT"
              fi
            elif echo "$PR_OUTPUT" | grep -qi "already exists"; then
              echo "âš ï¸ PR already exists or branch conflict"
              # Try to find the existing PR
              EXISTING_PR=$(gh pr list --repo ${{ github.repository }} --head $BRANCH_NAME --state open --json number --jq '.[0].number' || echo "")
              if [ -n "$EXISTING_PR" ]; then
                echo "Found existing PR #$EXISTING_PR"
                echo "pr_number=$EXISTING_PR" >> $GITHUB_OUTPUT
              fi
            else
              echo "âŒ Failed to create PR. Error:"
              echo "$PR_OUTPUT"
              # Don't exit with error, continue with workflow
              echo "pr_number=" >> $GITHUB_OUTPUT
            fi
          fi