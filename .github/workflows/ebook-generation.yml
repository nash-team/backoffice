name: Ebook Generation Pipeline

on:
  # D√©clench√© quand une issue est cr√©√©e ou rouverte
  issues:
    types: [opened, reopened]

  # Permet le d√©clenchement manuel pour tests
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to process'
        required: true
        type: string

env:
  PYTHON_VERSION: '3.11'

# Permissions explicites pour le GITHUB_TOKEN
permissions:
  contents: write      # Pour cr√©er des branches et commits
  issues: write        # Pour commenter sur les issues
  pull-requests: write # Pour cr√©er des PRs

jobs:
  # Job 1: Initialisation depuis une issue
  initialize-from-issue:
    name: Initialize from Issue
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'ebook-generation')) ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.issue_number != '')

    outputs:
      pr_number: ${{ steps.create-pr.outputs.pr_number }}
      spec_file: ${{ steps.parse.outputs.spec_file }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install PyYAML requests python-dotenv

      - name: Debug - Check token and API access
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number || github.event.inputs.issue_number }}
        run: |
          echo "Issue number: $ISSUE_NUMBER"
          echo "Repository: ${{ github.repository }}"
          echo "Testing API access with curl..."
          curl -s -H "Authorization: token $GITHUB_TOKEN" \
               -H "Accept: application/vnd.github.v3+json" \
               https://api.github.com/repos/${{ github.repository }}/issues/$ISSUE_NUMBER \
               | jq '.title, .state, .labels[].name' || echo "API call failed"

      - name: Parse issue and create spec
        id: parse
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number || github.event.inputs.issue_number }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          echo "Parsing issue #$ISSUE_NUMBER..."
          python .github/scripts/parse_issue.py \
            --issue-number $ISSUE_NUMBER \
            --repo $GITHUB_REPOSITORY \
            --output specs/ebook-$ISSUE_NUMBER.yaml
          echo "spec_file=specs/ebook-$ISSUE_NUMBER.yaml" >> $GITHUB_OUTPUT

      - name: Display spec
        run: |
          echo "üìã Spec file created:"
          cat specs/ebook-${{ github.event.issue.number || github.event.inputs.issue_number }}.yaml

      - name: Create draft PR
        id: create-pr
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number || github.event.inputs.issue_number }}
        run: |
          echo "üìù Creating draft PR for issue #$ISSUE_NUMBER..."

          # Create a new branch
          BRANCH_NAME="ebook-generation-$ISSUE_NUMBER"
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          # Check if branch already exists
          if git ls-remote --heads origin $BRANCH_NAME | grep -q $BRANCH_NAME; then
            echo "Branch $BRANCH_NAME already exists, checking it out..."
            git fetch origin $BRANCH_NAME
            git checkout $BRANCH_NAME
          else
            echo "Creating new branch $BRANCH_NAME..."
            git checkout -b $BRANCH_NAME
          fi

          # Create specs directory if it doesn't exist
          mkdir -p specs

          # Commit the spec file (if there are changes)
          git add specs/
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "feat: Add ebook generation spec for issue #$ISSUE_NUMBER"
          fi

          # Push the branch
          git push origin $BRANCH_NAME

          # Check if PR already exists
          EXISTING_PR=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/pulls?head=${{ github.repository_owner }}:$BRANCH_NAME&state=open" \
            | jq -r '.[0].number')

          if [ "$EXISTING_PR" != "null" ] && [ -n "$EXISTING_PR" ]; then
            echo "PR #$EXISTING_PR already exists for this branch"
            echo "pr_number=$EXISTING_PR" >> $GITHUB_OUTPUT
          else
            # Create PR using GitHub API
            PR_RESPONSE=$(curl -X POST \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/${{ github.repository }}/pulls \
              -d '{
                "title": "üé® Ebook #'$ISSUE_NUMBER': G√©n√©ration automatique",
                "body": "## üìö G√©n√©ration automatique depuis issue #'$ISSUE_NUMBER'\n\nCette PR contient la g√©n√©ration automatique de l'\''ebook demand√©.\n\n### ‚úÖ Checklist\n- [ ] Th√®me valid√©\n- [ ] G√©n√©ration lanc√©e\n- [ ] Review effectu√©e\n- [ ] Upload Drive\n\n### üìä Status\n- **Issue source**: #'$ISSUE_NUMBER'\n- **Branch**: `'$BRANCH_NAME'`\n- **√âtat**: Draft (en attente de g√©n√©ration)\n\n---\n*Cette PR a √©t√© cr√©√©e automatiquement par GitHub Actions*",
                "head": "'$BRANCH_NAME'",
                "base": "main",
                "draft": true
              }')

            PR_NUMBER=$(echo $PR_RESPONSE | jq -r '.number')

            if [ "$PR_NUMBER" = "null" ] || [ -z "$PR_NUMBER" ]; then
              echo "‚ùå Failed to create PR. Response:"
              echo $PR_RESPONSE
              exit 1
            fi

            echo "‚úÖ PR #$PR_NUMBER created successfully"
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT

            # Link PR to issue
            curl -X POST \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/${{ github.repository }}/issues/$ISSUE_NUMBER/comments \
              -d '{
                "body": "## üöÄ G√©n√©ration lanc√©e!\n\n‚úÖ PR cr√©√©e: #'$PR_NUMBER'\n\nLa g√©n√©ration de l'\''ebook va maintenant commencer. Vous pouvez suivre le progr√®s dans la PR.\n\n**Prochaines √©tapes**:\n1. Validation du th√®me\n2. G√©n√©ration des pages\n3. Assemblage PDF\n4. Review manuelle\n5. Upload vers Google Drive"
              }'
          fi