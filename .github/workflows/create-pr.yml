name: Create Pull Request

on:
  repository_dispatch:
    types: [create-ebook-pr]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  create-pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create Pull Request
        id: create-pr
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.client_payload.issue_number }}
          BRANCH_NAME: ${{ github.event.client_payload.branch_name }}
        run: |
          echo "Creating PR for issue #$ISSUE_NUMBER from branch $BRANCH_NAME"

          # Fetch the branch
          git fetch origin $BRANCH_NAME

          # Check if PR already exists
          EXISTING_PR=$(gh pr list --repo ${{ github.repository }} --head $BRANCH_NAME --state open --json number --jq '.[0].number' || echo "")

          if [ -n "$EXISTING_PR" ]; then
            echo "PR #$EXISTING_PR already exists for this branch"
            PR_NUMBER=$EXISTING_PR
          else
            # Create the PR
            PR_URL=$(gh pr create \
              --repo "${{ github.repository }}" \
              --title "üé® Ebook #$ISSUE_NUMBER: G√©n√©ration automatique" \
              --body "## üìö G√©n√©ration automatique depuis issue #$ISSUE_NUMBER

          Cette PR contient la g√©n√©ration automatique de l'ebook demand√©.

          ### ‚úÖ Checklist
          - [ ] Th√®me valid√©
          - [ ] G√©n√©ration lanc√©e
          - [ ] Review effectu√©e
          - [ ] Upload Drive

          ### üìä Status
          - **Issue source**: #$ISSUE_NUMBER
          - **Branch**: \`$BRANCH_NAME\`
          - **√âtat**: Draft (en attente de g√©n√©ration)

          ---
          *Cette PR a √©t√© cr√©√©e automatiquement par GitHub Actions*" \
              --base main \
              --head "$BRANCH_NAME" \
              --draft)

            if [ $? -eq 0 ]; then
              PR_NUMBER=$(echo "$PR_URL" | grep -oE '[0-9]+$')
              echo "‚úÖ PR #$PR_NUMBER created successfully"
            else
              echo "‚ùå Failed to create PR"
              exit 1
            fi
          fi

          # Comment on the issue
          gh issue comment "$ISSUE_NUMBER" \
            --repo "${{ github.repository }}" \
            --body "## üöÄ G√©n√©ration lanc√©e!

          ‚úÖ PR cr√©√©e: #$PR_NUMBER

          La g√©n√©ration de l'ebook va maintenant commencer. Vous pouvez suivre le progr√®s dans la PR.

          **Prochaines √©tapes**:
          1. Validation du th√®me
          2. G√©n√©ration des pages
          3. Assemblage PDF
          4. Review manuelle
          5. Upload vers Google Drive"
