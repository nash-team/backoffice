name: Ebook Generation Pipeline Test

on:
  # DÃ©clenchÃ© quand une issue est crÃ©Ã©e ou rouverte
  issues:
    types: [opened, reopened]

  # Permet le dÃ©clenchement manuel pour tests
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to process'
        required: true
        type: string

env:
  PYTHON_VERSION: '3.11'

# Permissions explicites pour le GITHUB_TOKEN
permissions:
  contents: read
  issues: read
  pull-requests: write

jobs:
  # Job 1: Initialisation depuis une issue
  initialize-from-issue:
    name: Initialize from Issue
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'ebook-generation')) ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.issue_number != '')

    outputs:
      pr_number: ${{ steps.create-pr.outputs.pr_number }}
      spec_file: ${{ steps.parse.outputs.spec_file }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install PyYAML requests python-dotenv

      - name: Debug - Check token and API access
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number || github.event.inputs.issue_number }}
        run: |
          echo "Issue number: $ISSUE_NUMBER"
          echo "Repository: ${{ github.repository }}"
          echo "Testing API access with curl..."
          curl -s -H "Authorization: token $GITHUB_TOKEN" \
               -H "Accept: application/vnd.github.v3+json" \
               https://api.github.com/repos/${{ github.repository }}/issues/$ISSUE_NUMBER \
               | jq '.title, .state, .labels[].name' || echo "API call failed"

      - name: Parse issue and create spec
        id: parse
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number || github.event.inputs.issue_number }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          echo "Parsing issue #$ISSUE_NUMBER..."
          python .github/scripts/parse_issue.py \
            --issue-number $ISSUE_NUMBER \
            --repo $GITHUB_REPOSITORY \
            --output specs/ebook-$ISSUE_NUMBER.yaml
          echo "spec_file=specs/ebook-$ISSUE_NUMBER.yaml" >> $GITHUB_OUTPUT

      # Pour l'instant on s'arrÃªte ici pour tester le parsing
      - name: Display spec
        run: |
          echo "ğŸ“‹ Spec file created:"
          cat specs/ebook-${{ github.event.issue.number || github.event.inputs.issue_number }}.yaml